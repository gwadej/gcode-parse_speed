#!/usr/bin/env perl

use strict;
use warnings;
use 5.010;

use Benchmark qw/cmpthese/;

my $num_matches = 167;

my @lines = do { open my $fh, '<', 'target/rose.gcode' or die; <$fh> };
cmpthese( 100, {
    naive        => \&naive_impl,
    'non-greedy' => \&non_greedy_impl,
    'greedy'     => \&greedy_impl,
    'substr'     => \&substr_impl,
    'index'      => \&index_impl,
});

sub naive_impl
{
    my ($line, $count) = ('', 0);
    for(@lines)
    {
        ($line, $count) = ($_, $count+1) if /^G[01]\b.*Z/;
    }
    say STDERR "Error naive ($count)" unless $count == $num_matches;
    return;
}

sub non_greedy_impl
{
    my ($line, $count) = ('', 0);
    for(@lines)
    {
        ($line, $count) = ($_, $count+1) if /^G[01](?![\d.]).*?Z/;
    }
    say STDERR "Error non-greedy ($count)" unless $count == $num_matches;
    return;
}

sub greedy_impl
{
    my ($line, $count) = ('', 0);
    for(@lines)
    {
        ($line, $count) = ($_, $count+1) if /^G[01](?![\d.]).*Z/;
    }
    say STDERR "Error greedy ($count)" unless $count == $num_matches;
    return;
}

sub substr_impl
{
    my ($line, $count, $match, $pos) = ('', 0, '', 0);
    for(@lines)
    {
        $match = substr( $_, 0, 2 );
        next unless $match eq 'G1' || $match eq 'G0';
        $match = substr( $_, 2, 1 );
        next if '0' le $match && $match le '9';
        next if -1 == ($pos = index( $_, 'Z', 3 ));
        $line = $_;
        ++$count;
    }
    say STDERR "Error substr ($count)" unless $count == $num_matches;
    return;
}

sub index_impl
{
    my ($line, $count, $match, $pos) = ('', 0, '', 0);
    for(@lines)
    {
        $match = substr( $_, 0, 2 );
        next unless $match eq 'G1' || $match eq 'G0';
        $match = substr( $_, 2, 1 );
        next if '0' le $match && $match le '9';
        next if -1 == ($pos = index( $_, 'Z', 3 ));
        $line = $_;
        ++$count;
    }
    say STDERR "Error index ($count)" unless $count == $num_matches;
    return;
}
